---
layout: lecture
title: "Backups"
presenter: Jose
video:
  aspect: 56.25
  id: lrpqYF8tcYQ
---

有两种类型的人：

- 那些做备份的人
- 那些将要做备份的人

您拥有但尚未备份的任何数据，都可能在任何时刻永远消失。在这里，我们将介绍一些良好的备份基础知识以及一些方法的缺陷。

## 3-2-1 法则

[3-2-1 法则](https://www.us-cert.gov/sites/default/files/publications/data_backup_options.pdf) 是一种备份数据的一般推荐策略。它规定您应该有：

- 至少 **3 份** 数据备份
- **2 份** 不同介质的备份
- 其中 **1 份** 备份在 **离线位置**

这个建议背后的主要思想是不要把所有的鸡蛋放在一个篮子里。拥有 2 个不同的设备/磁盘可以确保单个硬件故障不会带走您所有的数据。同样，如果您的唯一备份存储在家里，而房子被烧毁或被抢劫，您会失去一切，这就是离线备份的作用。本地备份为您提供了可用性和速度，而离线备份则为您提供了灾难发生时的弹性。

## 测试您的备份

进行备份时的一个常见陷阱是盲目相信系统所说的一切，并没有验证数据是否可以被正确恢复。《玩具总动员 2》几乎丢失，他们的备份不起作用，[运气](https://www.youtube.com/watch?v=8dhp_20j0Ys) 最终挽救了他们。

## 版本控制

您应该明白，[RAID](https://en.wikipedia.org/wiki/RAID) 不是备份，而且通常 **镜像不是备份解决方案**。简单地将文件同步到某个地方在几种情况下是无济于事的，例如：

- 数据损坏
- 恶意软件
- 误删文件

如果您的数据更改也传播到备份中，那么在这些情况下您将无法恢复。请注意，这对很多云存储解决方案来说都是这样，例如 Dropbox、Google Drive、One Drive 等。其中一些确实会保留已删除的数据一段时间，但通常恢复的接口并不适合用来恢复大量文件。

一个合适的备份系统应该是有版本控制的，以防止这种故障。通过提供不同时间点的快照，用户可以轻松地导航到它们来恢复丢失的任何内容。这类软件中最广为人知的是 macOS Time Machine。

## 数据去重

然而，制作多份数据副本可能在磁盘空间方面成本极高。然而，从一个版本到下一个版本，大多数数据都是相同的，不需要再次传输。这就是 [数据去重](https://en.wikipedia.org/wiki/Data_deduplication) 发挥作用的地方，通过跟踪已经存储的内容，可以进行 **增量备份**，只需存储从一个版本到下一个版本的更改。这显著减少了除第一个副本外备份所需的空间量。

## 加密

由于我们可能会将数据备份到不受信任的第三方（如云提供商），因此值得考虑的是，如果您备份的数据是 _原样_ 复制的，那么它有可能被不受欢迎的代理查看。像您的税务文件这样的文件是敏感信息，不应以纯文本格式备份。为了防止这种情况，许多备份解决方案提供 **客户端加密**，即在发送到服务器之前对数据进行加密。这样，服务器就无法读取它存储的数据，但您可以使用您的秘密密钥进行解密。

另外需要注意的是，如果您的磁盘（或主分区）未加密，那么任何拿到您计算机的人都可以覆盖用户访问控制并读取您的数据。现代硬件支持快速和高效的读写加密数据，因此您可能希望考虑启用 **全磁盘加密**。

## 仅追加

到目前为止讨论的属性侧重于硬件故障或用户错误，但未解决如果恶意代理想要删除您的数据时会发生什么的问题。换句话说，假设有人黑进了您的系统，他们能够删除您关心的所有数据吗？如果您担心这种情况，那么您需要某种形式的仅追加备份解决方案。一般来说，这意味着拥有一个服务器，该服务器允许您发送新数据，但拒绝删除现有数据。通常用户有两个密钥，一个仅追加密钥，支持创建新备份，另一个完全访问密钥，还允许删除不再需要的旧备份。后者存储在离线状态。

需要注意的是，这是一个相当具有挑战性的场景，因为您需要在保持对数据进行更改的能力的同时，防止恶意用户删除您的数据。现有的商业解决方案包括 [Tarsnap](https://www.tarsnap.com/) 和 [Borgbase](https://www.borgbase.com/)。

## 其他考虑因素

您可能还想考虑一些其他事项：

- **定期备份**：过时的备份可能会变得无用。定期进行备份应该是您系统的一个考虑因素
- **可启动备份**：一些程序允许您克隆整个磁盘。这样，您就有了一个包含整个系统副本的镜像，可以直接从中引导。
- **差异备份策略**，您可能并不一定关心所有数据相同的程度。您可以为不同类型的数据定义不同的备份策略。
- **仅追加备份** 另一个考虑是在备份存储库中强制执行仅追加操作，以防止恶意代理在拿到您的计算机后删除它们。

## Web 服务

您使用的所有数据都不一定存储在您的硬盘上。如果您使用 **网络服务**，那么您关心的一些数据，例如存储在 Google 文档中的演示文稿或 Spotify 播放列表，可能存储在在线上。另一个容易忘记的简单示例是具有 Web 访问的电子邮件帐户，例如 Gmail。在这些情况下找到备份解决方案有些棘手。然而，有许多服务允许您下载您的数据，直接或通过 API。工具如 [gmvault](https://github.com/gaubert/gmvault) 可用于将电子邮件文件下载到您的计算机。

## 网页

同样，一些高质量的内容可以以网页形式在线找到。如果说的内容是静态的，那么只需保存网站及其所有附件即可轻松备份它。另一个选择是 [Wayback Machine](https://archive.org/web/)，一个由 [互联网档案馆](https://archive.org/) 管理的世界范围内的大型数字档案，该组织专注于保存各种媒体。Wayback Machine 允许您捕获和存档网页，随后可以检索已存档的所有快照。如果您觉得它有用，请考虑向该项目 [捐赠](https://archive.org/donate/)。

## 资源

我们曾经使用并诚实推荐的一些优秀备份程序和服务：

- [Tarsnap](https://www.tarsnap.com/) - 适用于极度偏执者的去重、加密的在线备份服务。
- [Borg Backup](https://borgbackup.readthedocs.io) - 支持压缩和认证加密的去重备份程序。如果您需要云提供商 [rsync.net](https://www.rsync.net/products/borg.html) 为 Borg 用户提供特殊服务。
- [rsync](https://rsync.samba.org/) 是一个提供快速增量文件传输的实用程序。它不是一个完整的备份解决方案。
- [rclone](https://rclone.org/) 类似于 rsync，但用于云存储提供商，例如 Amazon S3、Dropbox、Google Drive、rsync.net 等。支持远程文件夹的客户端加密。

## 练习

1. 考虑您如何（不）备份您的数据，并考虑修复/改进它。

2. 弄清楚如何备份您的电子邮件帐户

3. 选择一个您经常使用的网络服务（Spotify、Google 音乐等），并查找备份您的数据的选项。通常情况下，人们已经基于可用的 API 制作了工具（例如 [youtube-dl](https://ytdl-org.github.io/youtube-dl/)）。

4. 想象一个多年来您反复访问的网站，然后在 [archive.org](https://archive.org/web/) 中查找它，它有多少个版本？

5. 一种高效实施去重的方法是使用硬链接。虽然符号链接（也称为软链接或符号链接）是指向另一个文件或文件夹的文件，但硬链接是指针的精确副本（它使用相同的 inode 并指向磁盘上的相同位置）。因此，如果原始文件被删除，符号链接将停止工作，而硬链接不会。然而，硬链接仅适用于文件。尝试使用 `ln` 命令创建硬链接，并将其与使用 `ln -s` 创建的符号链接进行比较。（在 macOS 中，您需要安装 GNU Coreutils 或 hln 包）。
